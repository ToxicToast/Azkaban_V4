name: Feature

on:
    push:
        branches: [feature/**/*, feature/*]

jobs:
    prepare:
        runs-on: ubuntu-latest
        name: 'Prepare Feature'
        outputs:
            branch: ${{ steps.extract_branch.outputs.branch }}
            version: ${{ steps.taggerDryRun.outputs.new_tag }}
        steps:
            - name: Extract branch name
              shell: bash
              run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
              id: extract_branch

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ğŸª Patch version for each merge (Dry Run)
              id: taggerDryRun
              uses: anothrNick/github-tag-action@1.71.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
                  WITH_V: true
                  DEFAULT_BUMP: patch
                  PRE_RELEASE: true
                  DRY_RUN: true

            - name: ğŸª Output Tag
              run: |
                  echo "${{ steps.taggerDryRun.outputs.new_tag }}"

    linting:
        needs: [prepare]
        runs-on: ubuntu-latest
        name: 'Check Format and Linting'
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: nrwl/nx-set-shas@v4

            - name: ğŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 21
                  cache: 'npm'

            - name: ğŸ“¦ Install NX-Linux
              run: npm install @nx/nx-linux-x64-gnu@latest

            - name: ğŸ“¦ Install dependencies
              run: npm install

            - name: ğŸš€ Check Format
              run: npx nx format:check

            - name: ğŸš€ Lint Apps
              run: npx nx affected:lint --parallel --maxParallel=3 --base=${{ needs.prepare.outputs.branch }}~1 --head=${{ needs.prepare.outputs.branch }}

    testing:
        needs: [prepare]
        runs-on: ubuntu-latest
        name: 'Test Apps'
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: nrwl/nx-set-shas@v4

            - name: ğŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 21
                  cache: 'npm'

            - name: ğŸ“¦ Install NX-Linux
              run: npm install @nx/nx-linux-x64-gnu@latest

            - name: ğŸ“¦ Install dependencies
              run: npm install

            - name: ğŸš€ Test Apps
              run: npx nx affected:test --passWithNoTests --parallel --maxParallel=3 --base=${{ needs.prepare.outputs.branch }}~1 --head=${{ needs.prepare.outputs.branch }}

            - name: ğŸš€ e2e Apps
              run: npx nx affected:e2e --passWithNoTests --parallel --maxParallel=3 --base=${{ needs.prepare.outputs.branch }}~1 --head=${{ needs.prepare.outputs.branch }}

    building:
        needs: [prepare]
        uses: ./.github/workflows/extends/build.yaml
        with:
            max-parallel: 3
            branch: ${{ needs.prepare.outputs.branch }}
    docker:
        needs: [prepare, linting, testing, building]
        runs-on: ubuntu-latest
        name: 'Publish Docker Image'
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: nrwl/nx-set-shas@v4

            - name: ğŸ“¦ Login into Docker
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: ğŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 21
                  cache: 'npm'

            - name: ğŸ“¦ Install NX-Linux
              run: npm install @nx/nx-linux-x64-gnu@latest

            - name: ğŸ“¦ Install dependencies
              run: npm install

            - name: ğŸ— Build Docker Images
              run: npx nx affected -t docker-build --base=${{ needs.prepare.outputs.branch }}~1 --head=${{ needs.prepare.outputs.branch }} --parallel --maxParallel=3 --VERSION=${{ needs.prepare.outputs.version }}

            - name: ğŸ— Push Docker Images
              run: npx nx affected -t docker-push --base=${{ needs.prepare.outputs.branch }}~1 --head=${{ needs.prepare.outputs.branch }} --parallel --maxParallel=3 --VERSION=${{ needs.prepare.outputs.version }}

    notify:
        needs: [docker]
        runs-on: ubuntu-latest
        name: 'Notify'
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ğŸª Patch version for each merge
              id: taggerDryRun
              uses: anothrNick/github-tag-action@1.71.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
                  WITH_V: true
                  DEFAULT_BUMP: patch
                  PRE_RELEASE: true

            - name: API Alerts Notify
              uses: apialerts/notify-action@v1
              with:
                  api_key: ${{ secrets.API_ALERTS_KEY }}
                  message: 'ğŸš¢ Feature - New Patch Released (${{ steps.taggerDryRun.outputs.new_tag }})'
                  tags: 'Azkaban,Feature'
                  link: 'https://github.com/ToxicToast/Azkaban_V4'
