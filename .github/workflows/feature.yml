name: Feature

on:
    push:
        branches: [feature/**/*, feature/*]

env:
    NODE_VERSION: 21
    MAX_PARALLEL: 3

jobs:
    Feature:
        runs-on: ubuntu-24.04

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: nrwl/nx-set-shas@v4

            - name: 📦 Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: 📦 Install dependencies
              run: npm install

            - name: 📦 Install NX-Linux
              run: npm install @nx/nx-linux-x64-gnu@latest

            - name: 🪐 Patch version for each merge (Dry Run)
              id: taggerDryRun
              uses: anothrNick/github-tag-action@1.71.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
                  WITH_V: true
                  DEFAULT_BUMP: patch
                  PRE_RELEASE: true
                  DRY_RUN: true

            - name: Extract branch name
              shell: bash
              run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
              id: extract_branch

            - name: 🚀 Build Apps
              run: npm run nx affected:build --parallel --maxParallel=${{ env.MAX_PARALLEL }} --base=${{ steps.extract_branch.outputs.branch }}~1 --head=${{ steps.extract_branch.outputs.branch }}

            - name: 🏗 Build Docker Images
              run: npm run nx affected -t docker-build --parallel --maxParallel=${{ env.MAX_PARALLEL }} --base=${{ steps.extract_branch.outputs.branch }}~1 --head=${{ steps.extract_branch.outputs.branch }} --VERSION=${{ steps.taggerDryRun.outputs.new_tag }}

            - name: 🏗 Push Docker Images
              run: npm run nx affected -t docker-push --parallel --maxParallel=${{ env.MAX_PARALLEL }} --base=${{ steps.extract_branch.outputs.branch }}~1 --head=${{ steps.extract_branch.outputs.branch }} --VERSION=${{ steps.taggerDryRun.outputs.new_tag }}

            - name: 🏗 API Alerts Notify
              uses: apialerts/notify-action@v2
              with:
                  api_key: ${{ secrets.API_ALERTS_KEY }}
                  message: '🚢 Feature - New Patch Released (${{ steps.taggerDryRun.outputs.new_tag }})'
                  tags: 'Azkaban,Patch'
                  link: 'https://github.com/ToxicToast/Azkaban_V4'
                  channel: 'cicd'
